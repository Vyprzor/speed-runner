<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Speed Runner</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { overflow: hidden; font-family: 'Arial', sans-serif; background: #000; }
    canvas { display: block; }
    #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    .menu-screen { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white; pointer-events: all; display: none; background: rgba(0,0,0,0.9); padding: 40px; border-radius: 20px; max-height: 90vh; overflow-y: auto; z-index: 100; }
    #mainMenu { display: block; }
    .menu-screen h1 { font-size: 72px; margin-bottom: 10px; text-shadow: 0 0 20px rgba(255, 255, 0, 0.8); letter-spacing: 6px; color: #ffff00; }
    .menu-screen h2 { font-size: 48px; margin-bottom: 30px; color: #ffff00; }
    .menu-screen p { font-size: 20px; margin-bottom: 30px; opacity: 0.9; }
    .menu-screen button { padding: 20px 60px; font-size: 28px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); border: none; border-radius: 10px; color: white; cursor: pointer; transition: transform 0.2s; font-weight: bold; margin: 10px; }
    .menu-screen button:hover { transform: scale(1.05); }
    .green-btn { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%) !important; }
    .blue-btn { background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%) !important; }
    .purple-btn { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%) !important; }
    #levelSelect { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 20px 0; }
    #levelSelect button { padding: 15px; font-size: 20px; margin: 0; }
    .locked { background: #555 !important; cursor: not-allowed !important; }
    #codeInput { padding: 15px 30px; font-size: 20px; border-radius: 10px; border: 2px solid #fff; margin: 20px 0; width: 300px; }
    #pauseMenu { background: rgba(0,0,0,0.95); }
    #hud { position: absolute; top: 30px; left: 30px; color: white; font-size: 28px; display: none; text-shadow: 0 3px 10px rgba(0,0,0,0.9); font-weight: bold; }
    #hud div { margin-bottom: 12px; }
    #progressBar { width: 300px; height: 30px; background: rgba(0,0,0,0.5); border: 3px solid white; border-radius: 15px; margin-top: 10px; overflow: hidden; }
    #progressFill { height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; transition: width 0.3s; }
    #levelComplete { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white; display: none; pointer-events: all; animation: pulse 0.5s; z-index: 10; }
    @keyframes pulse { 0%, 100% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.1); } }
    #levelComplete h2 { font-size: 80px; color: #4CAF50; margin-bottom: 20px; text-shadow: 0 0 40px rgba(76, 175, 80, 1); }
    #levelComplete button { padding: 15px 50px; font-size: 24px; background: #4CAF50; border: none; border-radius: 10px; color: white; cursor: pointer; font-weight: bold; margin: 10px; }
    #deathScreen { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white; display: none; pointer-events: all; z-index: 10; }
    #deathScreen h2 { font-size: 80px; color: #ff4444; margin-bottom: 20px; text-shadow: 0 0 40px rgba(255, 68, 68, 1); }
    #deathScreen button { padding: 15px 50px; font-size: 24px; background: #ff6b6b; border: none; border-radius: 10px; color: white; cursor: pointer; margin: 10px; font-weight: bold; }
    #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; background: white; border-radius: 50%; box-shadow: 0 0 5px black, 0 0 10px black; display: none; }
    .help-section { text-align: left; margin: 20px 0; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; }
    .help-section h3 { color: #4CAF50; margin-bottom: 10px; }
    #devWindow { position: fixed; top: 100px; right: 20px; width: 320px; background: rgba(20, 20, 20, 0.95); border: 2px solid #4CAF50; border-radius: 10px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); display: none; pointer-events: all; z-index: 10000; }
    #devWindow.minimized .dev-content { display: none; }
    #devWindow.minimized { width: 200px; }
    .dev-header { background: linear-gradient(135deg, #4CAF50, #45a049); padding: 12px 15px; border-radius: 8px 8px 0 0; cursor: move; display: flex; justify-content: space-between; align-items: center; user-select: none; }
    .dev-header h3 { margin: 0; font-size: 18px; color: white; flex: 1; }
    .dev-header-buttons { display: flex; gap: 8px; }
    .dev-header-btn { width: 24px; height: 24px; border: none; border-radius: 4px; background: rgba(255,255,255,0.2); color: white; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
    .dev-header-btn:hover { background: rgba(255,255,255,0.3); }
    .dev-content { padding: 15px; }
    .dev-section { margin-bottom: 15px; }
    .dev-section h4 { color: #4CAF50; margin-bottom: 8px; font-size: 14px; }
    .dev-controls { display: flex; flex-direction: column; gap: 8px; }
    .dev-controls button { padding: 10px; font-size: 14px; background: linear-gradient(135deg, #555, #444); border: none; border-radius: 6px; color: white; cursor: pointer; transition: all 0.2s; font-weight: bold; }
    .dev-controls button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
    .dev-controls button.active { background: linear-gradient(135deg, #4CAF50, #45a049); }
    .dev-key-hint { display: flex; align-items: center; gap: 8px; margin-top: 5px; font-size: 12px; color: #aaa; }
    .dev-key { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 3px; font-family: monospace; }
    
    /* Enhanced Coin Display */
    #coinDisplay { 
        position: absolute; 
        top: 30px; 
        right: 30px; 
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 193, 7, 0.3));
        backdrop-filter: blur(10px);
        border: 3px solid #FFD700;
        border-radius: 20px;
        padding: 15px 30px;
        font-size: 36px;
        font-weight: bold;
        color: #FFD700;
        text-shadow: 0 3px 10px rgba(0, 0, 0, 0.9), 0 0 20px rgba(255, 215, 0, 0.5);
        display: none;
        pointer-events: none;
        box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);
        animation: coinPulse 2s ease-in-out infinite;
    }
    
    @keyframes coinPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    /* Coin Popup Notification */
    .coin-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 72px;
        font-weight: bold;
        color: #FFD700;
        text-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 3px 10px rgba(0, 0, 0, 0.9);
        pointer-events: none;
        z-index: 9999;
        animation: coinPopup 1s ease-out forwards;
    }
    
    @keyframes coinPopup {
        0% {
            transform: translate(-50%, -50%) scale(0) rotate(0deg);
            opacity: 0;
        }
        50% {
            transform: translate(-50%, -50%) scale(1.3) rotate(180deg);
            opacity: 1;
        }
        100% {
            transform: translate(-50%, -100px) scale(1) rotate(360deg);
            opacity: 0;
        }
    }
    
    /* Shop Menu Styles */
    #shopMenu {
        max-width: 900px;
        width: 90vw;
    }
    
    .shop-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 193, 7, 0.3));
        border-radius: 15px;
        border: 2px solid #FFD700;
    }
    
    .shop-balance {
        font-size: 42px;
        font-weight: bold;
        color: #FFD700;
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
    }
    
    .shop-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }
    
    .shop-item {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        border: 3px solid transparent;
        border-radius: 15px;
        padding: 25px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .shop-item:hover {
        transform: translateY(-5px);
        border-color: #FFD700;
        box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
    }
    
    .shop-item.owned {
        border-color: #4CAF50;
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.1));
    }
    
    .shop-item-icon {
        font-size: 64px;
        margin-bottom: 15px;
    }
    
    .shop-item-name {
        font-size: 24px;
        font-weight: bold;
        color: #fff;
        margin-bottom: 10px;
    }
    
    .shop-item-desc {
        font-size: 16px;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 20px;
        line-height: 1.4;
    }
    
    .shop-item-price {
        font-size: 28px;
        font-weight: bold;
        color: #FFD700;
        margin-bottom: 15px;
    }
    
    .shop-item button {
        width: 100%;
        padding: 15px;
        font-size: 20px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
    }
    
    .shop-item button:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 20px rgba(76, 175, 80, 0.5);
    }
    
    .shop-item button:disabled {
        background: linear-gradient(135deg, #555, #444);
        cursor: not-allowed;
        transform: none;
    }
    
    .shop-item.owned::before {
        content: "‚úì OWNED";
        position: absolute;
        top: 10px;
        right: 10px;
        background: #4CAF50;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
    }
</style>
</head>
<body>
<div id="ui">
    <div id="mainMenu" class="menu-screen">
        <h1>SPEED RUNNER</h1>
        <p>Look where you want to go!</p>
        <button onclick="startGame()">PLAY</button>
        <button class="blue-btn" onclick="showScreen('levelSelectMenu')">LEVEL SELECT</button>
        <button class="green-btn" onclick="showScreen('settingsMenu')">SETTINGS</button>
        <button class="purple-btn" onclick="showScreen('codesMenu')">CODES</button>
        <button onclick="showScreen('helpMenu')">HELP</button>
        <button class="green-btn" onclick="showScreen('shopMenu')">SHOP üõí</button>
        <button style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%) !important;" onclick="exitGame()">EXIT GAME</button>
        <p style="font-size: 14px; margin-top: 30px; opacity: 0.6;">Created by Zaydon.</p>
    </div>
    
    <div id="shopMenu" class="menu-screen">
        <h2>üõí SHOP</h2>
        <div class="shop-header">
            <div>
                <div style="font-size: 20px; opacity: 0.8; margin-bottom: 5px;">Your Balance</div>
                <div class="shop-balance">üí∞ <span id="shopCoins">0</span></div>
            </div>
        </div>
        
        <div class="shop-grid">
            <div class="shop-item" id="item_rainbox">
                <div class="shop-item-icon">üì¶üåà</div>
                <div class="shop-item-name">Rainbox</div>
                <div class="shop-item-desc">Level changes colors</div>
                <div class="shop-item-price">üí∞ 10 Coins</div>
                <button id="btn_rainbox" onclick="toggleItem('rainbox', 10)">BUY NOW</button>
            </div>
            
            <div class="shop-item" id="item_triple_jump">
                <div class="shop-item-icon">üöÄ</div>
                <div class="shop-item-name">Triple Jump</div>
                <div class="shop-item-desc">Jump 3 times instead of 2</div>
                <div class="shop-item-price">üí∞ 100 Coins</div>
                <button id="btn_triple_jump" onclick="toggleItem('triple_jump', 100)">BUY NOW</button>
            </div>
        </div>
        
        <button onclick="showScreen('mainMenu')" style="margin-top: 20px;">BACK TO MENU</button>
    </div>
    
    <div id="levelSelectMenu" class="menu-screen">
        <h2>SELECT LEVEL</h2>
        <div id="levelSelect"></div>
        <button onclick="showScreen('mainMenu')">BACK</button>
    </div>
    <div id="settingsMenu" class="menu-screen">
        <h2>SETTINGS</h2>
        <label for="sensitivitySlider">Mouse Sensitivity</label>
        <input type="range" id="sensitivitySlider" min="0.5" max="5" step="0.1" value="2.5" oninput="updateSensitivity(this.value)">
        <div style="color: #4CAF50; font-size: 20px; margin: 10px 0;">Sensitivity: <span id="sensValue">2.5</span></div>
        <button onclick="backFromSettings()">BACK</button>
    </div>
    <div id="codesMenu" class="menu-screen">
        <h2>ENTER CODE</h2>
        <input type="text" id="codeInput" placeholder="Enter code here...">
        <br>
        <button class="green-btn" onclick="submitCode()">SUBMIT</button>
        <button onclick="showScreen('mainMenu')">BACK</button>
        <p id="codeMessage" style="margin-top: 20px; color: #ff6b6b;"></p>
    </div>
    <div id="helpMenu" class="menu-screen">
        <h2>HOW TO PLAY</h2>
        <div class="help-section">
            <h3>üéÆ Controls</h3>
            <p>‚Ä¢ <strong>MOUSE</strong> - Look around and steer direction</p>
            <p>‚Ä¢ <strong>SPACE</strong> - Jump (you have a DOUBLE JUMP!)</p>
            <p>‚Ä¢ <strong>ESC</strong> - Pause menu</p>
        </div>
        <div class="help-section">
            <h3>üèÉ Objective</h3>
            <p>Run forward automatically and navigate through platforms to reach the green end platform!</p>
        </div>
        <div class="help-section">
            <h3>üí° Tips</h3>
            <p>‚Ä¢ You can jump shortly after leaving a platform</p>
            <p>‚Ä¢ Use DOUBLE JUMP to reach far platforms</p>
            <p>‚Ä¢ Look where you want to go - you move in that direction</p>
            <p>‚Ä¢ Each level gets faster and more challenging</p>
            <p>‚Ä¢ Collect coins to buy items in the shop!</p>
        </div>
        <button onclick="showScreen('mainMenu')">BACK</button>
    </div>
    <div id="pauseMenu" class="menu-screen">
        <h2>PAUSED</h2>
        <button class="green-btn" onclick="resumeGame()">RESUME</button>
        <button class="blue-btn" onclick="showScreen('levelSelectMenu')">LEVEL SELECT</button>
        <button onclick="showScreen('settingsMenu')">SETTINGS</button>
        <button onclick="quitToMenu()">QUIT TO MENU</button>
    </div>
    <div id="hud">
        <div>LEVEL: <span id="level">1</span>/20</div>
        <div>COINS: <span id="coinCounter">0</span></div>
        <div>SPEED: <span id="speedDisplay">0</span></div>
        <div>DISTANCE: <span id="distanceDisplay">0</span>m / <span id="totalDistance">0</span>m</div>
        <div id="progressBar"><div id="progressFill"></div></div>
    </div>
    <div id="levelComplete">
        <h2>LEVEL COMPLETE!</h2>
        <button onclick="nextLevel()">NEXT LEVEL</button>
        <button style="background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%) !important;" onclick="quitToMenu()">MAIN MENU</button>
        <button class="blue-btn" onclick="openSettingsFromComplete()">SETTINGS</button>
    </div>
    <div id="deathScreen">
        <h2>YOU FELL!</h2>
        <button onclick="restartLevel()">RESTART LEVEL</button>
        <button style="background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%) !important;" onclick="quitToMenu()">MAIN MENU</button>
        <button class="blue-btn" onclick="openSettingsFromDeath()">SETTINGS</button>
        <button class="purple-btn" onclick="openDevFromDeath()" style="display:none;" id="devBtnDeath">DEV MENU</button>
    </div>
    <div id="crosshair"></div>
    
    <div id="coinDisplay">
        üí∞ <span id="coinCount">0</span>
    </div>
</div>
<div id="devWindow">
    <div class="dev-header" id="devHeader">
        <h3>üîß DEV MENU</h3>
        <div class="dev-header-buttons">
            <button class="dev-header-btn" onclick="toggleMinimizeDevMenu()" title="Minimize">_</button>
            <button class="dev-header-btn" onclick="closeDevMenu()" title="Close">√ó</button>
        </div>
    </div>
    <div class="dev-content">
        <div class="dev-section">
            <h4>MOVEMENT</h4>
            <div class="dev-controls">
                <button id="flightBtn" onclick="toggleFlight()">Flight Mode: OFF</button>
                <div class="dev-key-hint"><span class="dev-key">F</span> Toggle Flight (WASDQE to fly)</div>
                <button id="infiniteJumpBtn" onclick="toggleInfiniteJump()">Infinite Jump: OFF</button>
                <div class="dev-key-hint"><span class="dev-key">J</span> Toggle Infinite Jump</div>
                <button id="noclipBtn" onclick="toggleNoclip()">Noclip: OFF</button>
                <div class="dev-key-hint"><span class="dev-key">N</span> Toggle Noclip (no collisions)</div>
            </div>
        </div>
        <div class="dev-section">
            <h4>SPEED CONTROL</h4>
            <div class="dev-controls">
                <button onclick="adjustSpeed(-0.2)">Slower (-)</button>
                <button onclick="adjustSpeed(0.2)">Faster (+)</button>
                <button onclick="resetSpeed()">Reset Speed</button>
                <div style="color: #4CAF50; font-size: 12px; margin-top: 5px;">Current: <span id="speedMultiplier">1.0x</span></div>
            </div>
        </div>
        <div class="dev-section">
            <h4>LEVEL CONTROL</h4>
            <div class="dev-controls">
                <button onclick="skipLevel()">Skip Level</button>
                <button onclick="unlockAllLevels()">Unlock All Levels</button>
                <button onclick="teleportToEnd()">Teleport to End</button>
            </div>
        </div>
        <div class="dev-section">
            <h4>PLAYER CONTROL</h4>
            <div class="dev-controls">
                <button id="godModeBtn" onclick="toggleGodMode()">God Mode: OFF</button>
                <button onclick="resetPosition()">Reset Position</button>
            </div>
        </div>
        <div class="dev-section">
            <h4>COINS</h4>
            <div class="dev-controls">
                <button onclick="addCoins(10)">Add 10 Coins</button>
                <button onclick="addCoins(50)">Add 50 Coins</button>
                <button onclick="addCoins(100)">Add 100 Coins</button>
                <button onclick="resetCoins()">Reset Coins</button>
                <div style="color: #FFD700; font-size: 12px; margin-top: 5px;">Total: <span id="devCoins">0</span> üí∞</div>
            </div>
        </div>
        <div class="dev-section">
            <h4>DANGER ZONE</h4>
            <div class="dev-controls">
                <button onclick="resetProgress()" style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f);">Reset Progress</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
let scene,camera,renderer,player,platforms=[],coinMeshes=[],trailParticles=[];
let gameState='menu',velocity={x:0,y:0,z:0},onGround=false,lastGroundTime=0,jumpsRemaining=2;
const GRAVITY=-0.028,JUMP_FORCE=0.75,COYOTE_TIME=0.15;
let pitch=0,yaw=0,sensitivity=0.0025;
const MAX_YAW=Math.PI/3,MIN_PITCH=-Math.PI/6,MAX_PITCH=Math.PI/4;
let currentLevel=1,MAX_LEVELS=20,forwardSpeed=0.3,levelStartZ=0,levelEndZ=0,unlockedLevels=1;
let devModeActive=false,flightMode=false,infiniteJump=false,devWindowMinimized=false,noclipMode=false,godMode=false,speedMultiplier=1.0,coins=0;
let ownedItems={rainbox:false,triple_jump:false};
let itemsEnabled={rainbox:false,triple_jump:false};
let isDragging=false,dragOffsetX=0,dragOffsetY=0;
let rainbowHue=0,levelRainbowHue=0;
const keys={};
const levelColors=[0xFF6B6B,0x4ECDC4,0x45B7D1,0xFFA07A,0x98D8C8,0xF7DC6F,0xBB8FCE,0x85C1E2,0xF8B500,0x52D726,0xFF1744,0x00E5FF,0xC6FF00,0xFF6E40,0x651FFF,0x00BFA5,0xFFAB00,0xD500F9,0x00B8D4,0xFF3D00];

function init(){
    scene=new THREE.Scene();
    scene.fog=new THREE.Fog(0x87CEEB,100,300);
    camera=new THREE.PerspectiveCamera(85,window.innerWidth/window.innerHeight,0.1,1000);
    renderer=new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth,window.innerHeight);
    renderer.shadowMap.enabled=true;
    document.body.appendChild(renderer.domElement);
    const ambientLight=new THREE.AmbientLight(0xffffff,0.7);
    scene.add(ambientLight);
    const dirLight=new THREE.DirectionalLight(0xffffff,0.7);
    dirLight.position.set(10,30,10);
    dirLight.castShadow=true;
    scene.add(dirLight);
    const playerGeometry=new THREE.BoxGeometry(2,3,2);
    const playerMaterial=new THREE.MeshStandardMaterial({color:0xFFEB3B});
    player=new THREE.Mesh(playerGeometry,playerMaterial);
    player.castShadow=true;
    scene.add(player);
    document.addEventListener('keydown',e=>{keys[e.code]=true;onKeyDown(e);});
    document.addEventListener('keyup',e=>keys[e.code]=false);
    document.addEventListener('mousemove',onMouseMove);
    document.addEventListener('click',()=>{if(gameState==='playing'&&document.pointerLockElement!==document.body){document.body.requestPointerLock();}});
    document.addEventListener('pointerlockchange',()=>{if(!document.pointerLockElement&&gameState==='playing'){setTimeout(()=>{document.body.requestPointerLock();},100);}});
    window.addEventListener('resize',onWindowResize);
    const devHeader=document.getElementById('devHeader');
    devHeader.addEventListener('mousedown',startDrag);
    document.addEventListener('mousemove',drag);
    document.addEventListener('mouseup',stopDrag);
    generateLevel(currentLevel);
    generateLevelSelect();
    updateAllCoinDisplays();
    updateShopDisplay();
    animate();
}

function startDrag(e){if(e.target.classList.contains('dev-header-btn'))return;isDragging=true;const devWindow=document.getElementById('devWindow');const rect=devWindow.getBoundingClientRect();dragOffsetX=e.clientX-rect.left;dragOffsetY=e.clientY-rect.top;}
function drag(e){if(!isDragging)return;e.preventDefault();const devWindow=document.getElementById('devWindow');let newLeft=e.clientX-dragOffsetX,newTop=e.clientY-dragOffsetY;const maxLeft=window.innerWidth-devWindow.offsetWidth,maxTop=window.innerHeight-devWindow.offsetHeight;newLeft=Math.max(0,Math.min(newLeft,maxLeft));newTop=Math.max(0,Math.min(newTop,maxTop));devWindow.style.left=newLeft+'px';devWindow.style.top=newTop+'px';devWindow.style.right='auto';}
function stopDrag(){isDragging=false;}

function onKeyDown(e){
    if(e.code==='Escape'&&gameState==='playing'){pauseGame();return;}
    if(devModeActive){
        if(e.code==='KeyF'){toggleFlight();return;}
        if(e.code==='KeyJ'){toggleInfiniteJump();return;}
        if(e.code==='KeyN'){toggleNoclip();return;}
    }
    if(e.code==='Space'&&gameState==='playing'){e.preventDefault();const timeSinceGrounded=(performance.now()/1000)-lastGroundTime;let maxJumps=itemsEnabled.triple_jump?3:2;if(flightMode){velocity.y=JUMP_FORCE;}else if(infiniteJump||(jumpsRemaining>0&&(onGround||timeSinceGrounded<COYOTE_TIME||jumpsRemaining<maxJumps))){velocity.y=JUMP_FORCE;if(!infiniteJump){jumpsRemaining--;}onGround=false;}}
}

function generateLevel(levelNum){
    platforms.forEach(p=>scene.remove(p));
    platforms=[];
    coinMeshes.forEach(c=>scene.remove(c));
    coinMeshes=[];
    const levelColor=levelColors[levelNum-1];
    scene.background=new THREE.Color(levelColor).multiplyScalar(0.3);
    scene.fog.color=new THREE.Color(levelColor).multiplyScalar(0.3);
    forwardSpeed=(0.3+(levelNum-1)*0.08)*speedMultiplier;
    const startPlat=createPlatform(30,1,40,0,0,0,levelColor);
    platforms.push(startPlat);
    levelStartZ=0;
    let z=-30;
    const numPlatforms=15+levelNum*1;
    for(let i=0;i<numPlatforms;i++){
        const width=10+Math.random()*8,depth=10+Math.random()*8,y=(Math.random()-0.5)*15,x=(Math.random()-0.5)*30;
        const platform=createPlatform(width,1,depth,x,y,z,levelColor);
        platforms.push(platform);
        if(Math.random()<0.5){
            const coinGeometry=new THREE.CylinderGeometry(0.8,0.8,0.3,16);
            const coinMaterial=new THREE.MeshStandardMaterial({color:0xFFD700,emissive:0xFFD700,emissiveIntensity:0.5,metalness:0.8,roughness:0.2});
            const coin=new THREE.Mesh(coinGeometry,coinMaterial);
            coin.position.set(x+(Math.random()-0.5)*width*0.5,y+3,z+(Math.random()-0.5)*depth*0.5);
            coin.rotation.x=Math.PI/2;
            coin.userData.isCoin=true;
            coin.userData.collected=false;
            scene.add(coin);
            coinMeshes.push(coin);
        }
        z-=18+Math.random()*6+levelNum*0.5;
    }
    const endPlat=createPlatform(20,1,20,0,0,z-20,0x4CAF50);
    endPlat.userData.isEnd=true;
    platforms.push(endPlat);
    if(levelNum>=5){
        const barrierHeight=50,barrierWidth=100,barrierDepth=5,barrierZ=z-35;
        const barrierGeometry=new THREE.BoxGeometry(barrierWidth,barrierHeight,barrierDepth);
        const barrierMaterial=new THREE.MeshBasicMaterial({transparent:true,opacity:0,visible:true});
        const barrier=new THREE.Mesh(barrierGeometry,barrierMaterial);
        barrier.position.set(0,barrierHeight/2,barrierZ);
        barrier.userData.isBarrier=true;
        scene.add(barrier);
        platforms.push(barrier);
    }
    levelEndZ=z-20;
    document.getElementById('totalDistance').textContent=Math.abs(Math.floor(levelEndZ));
}

function createPlatform(w,h,d,x,y,z,color){const geometry=new THREE.BoxGeometry(w,h,d);const material=new THREE.MeshStandardMaterial({color:color,emissive:color,emissiveIntensity:0.1});const mesh=new THREE.Mesh(geometry,material);mesh.position.set(x,y,z);mesh.castShadow=true;mesh.receiveShadow=true;scene.add(mesh);return mesh;}
function generateLevelSelect(){const container=document.getElementById('levelSelect');container.innerHTML='';for(let i=1;i<=MAX_LEVELS;i++){const btn=document.createElement('button');btn.textContent=i;if(i<=unlockedLevels){btn.onclick=()=>startFromLevel(i);}else{btn.classList.add('locked');btn.textContent='üîí';}container.appendChild(btn);}}
function startFromLevel(level){currentLevel=level;document.getElementById('level').textContent=currentLevel;generateLevel(currentLevel);startGame();}
function startGame(){
    hideAllScreens();
    document.getElementById('hud').style.display='block';
    document.getElementById('crosshair').style.display='block';
    document.getElementById('coinDisplay').style.display='block';
    if(devModeActive)document.getElementById('devWindow').style.display='block';
    gameState='playing';
    player.position.set(0,2,0);
    velocity={x:0,y:0,z:0};
    pitch=0;
    yaw=0;
    jumpsRemaining=itemsEnabled.triple_jump?3:2;
    setTimeout(()=>{document.body.requestPointerLock();},100);
}
function quitToMenu(){gameState='menu';document.exitPointerLock();hideAllScreens();document.getElementById('hud').style.display='none';document.getElementById('crosshair').style.display='none';document.getElementById('coinDisplay').style.display='none';document.getElementById('levelComplete').style.display='none';document.getElementById('deathScreen').style.display='none';if(devModeActive){document.getElementById('devWindow').style.display='block';}showScreen('mainMenu');}
function showScreen(screenId){hideAllScreens();document.getElementById('levelComplete').style.display='none';document.getElementById('deathScreen').style.display='none';document.getElementById(screenId).style.display='block';if(screenId==='shopMenu'){updateShopDisplay();}if(devModeActive){document.getElementById('devWindow').style.display='block';}}
function hideAllScreens(){document.querySelectorAll('.menu-screen').forEach(screen=>{screen.style.display='none';});}
function backFromSettings(){hideAllScreens();if(gameState==='paused'){showScreen('pauseMenu');}else if(gameState==='dead'){document.getElementById('deathScreen').style.display='block';}else if(gameState==='levelComplete'){document.getElementById('levelComplete').style.display='block';}else{showScreen('mainMenu');}}
function openSettingsFromDeath(){gameState='dead';document.getElementById('deathScreen').style.display='none';showScreen('settingsMenu');}
function openSettingsFromComplete(){gameState='levelComplete';document.getElementById('levelComplete').style.display='none';showScreen('settingsMenu');}
function openDevFromDeath(){document.getElementById('devWindow').style.display='block';}
function updateSensitivity(value){sensitivity=value*0.001;document.getElementById('sensValue').textContent=value;}
function submitCode(){const code=document.getElementById('codeInput').value.trim();const msg=document.getElementById('codeMessage');if(code==='admin124'){devModeActive=true;msg.style.color='#4CAF50';msg.textContent='‚úì Developer mode activated!';document.getElementById('devWindow').style.display='block';document.getElementById('devBtnDeath').style.display='inline-block';document.getElementById('codeInput').value='';setTimeout(()=>showScreen('mainMenu'),1000);}else{msg.style.color='#ff6b6b';msg.textContent='‚úó Invalid code';}}
function toggleFlight(){flightMode=!flightMode;const btn=document.getElementById('flightBtn');if(flightMode){btn.textContent='Flight Mode: ON';btn.classList.add('active');}else{btn.textContent='Flight Mode: OFF';btn.classList.remove('active');}}
function toggleInfiniteJump(){infiniteJump=!infiniteJump;const btn=document.getElementById('infiniteJumpBtn');if(infiniteJump){btn.textContent='Infinite Jump: ON';btn.classList.add('active');}else{btn.textContent='Infinite Jump: OFF';btn.classList.remove('active');}}
function toggleNoclip(){noclipMode=!noclipMode;const btn=document.getElementById('noclipBtn');if(noclipMode){btn.textContent='Noclip: ON';btn.classList.add('active');}else{btn.textContent='Noclip: OFF';btn.classList.remove('active');}}
function toggleGodMode(){godMode=!godMode;const btn=document.getElementById('godModeBtn');if(godMode){btn.textContent='God Mode: ON';btn.classList.add('active');}else{btn.textContent='God Mode: OFF';btn.classList.remove('active');}}
function adjustSpeed(amount){speedMultiplier+=amount;if(speedMultiplier<0.1)speedMultiplier=0.1;if(speedMultiplier>5)speedMultiplier=5;document.getElementById('speedMultiplier').textContent=speedMultiplier.toFixed(1)+'x';forwardSpeed=(0.3+(currentLevel-1)*0.08)*speedMultiplier;}
function resetSpeed(){speedMultiplier=1.0;document.getElementById('speedMultiplier').textContent='1.0x';forwardSpeed=(0.3+(currentLevel-1)*0.08)*speedMultiplier;}
function teleportToEnd(){player.position.set(0,2,levelEndZ+10);velocity={x:0,y:0,z:0};}
function resetPosition(){player.position.set(0,2,0);velocity={x:0,y:0,z:0};pitch=0;yaw=0;}
function showCoinPopup(){
    const popup=document.createElement('div');
    popup.className='coin-popup';
    popup.textContent='+1 üí∞';
    document.getElementById('ui').appendChild(popup);
    setTimeout(()=>{popup.remove();},1000);
}
function createCoinParticles(pos){
    for(let i=0;i<10;i++){
        const particleGeometry=new THREE.SphereGeometry(0.1,8,8);
        const particleMaterial=new THREE.MeshBasicMaterial({color:0xFFD700});
        const particle=new THREE.Mesh(particleGeometry,particleMaterial);
        particle.position.copy(pos);
        const vel={x:(Math.random()-0.5)*0.3,y:Math.random()*0.5,z:(Math.random()-0.5)*0.3};
        particle.userData.velocity=vel;
        particle.userData.life=30;
        scene.add(particle);
        const animateParticle=()=>{
            if(particle.userData.life<=0){
                scene.remove(particle);
                return;
            }
            particle.position.x+=particle.userData.velocity.x;
            particle.position.y+=particle.userData.velocity.y;
            particle.position.z+=particle.userData.velocity.z;
            particle.userData.velocity.y-=0.02;
            particle.userData.life--;
            particle.material.opacity=particle.userData.life/30;
            requestAnimationFrame(animateParticle);
        };
        animateParticle();
    }
}
function updateShopDisplay(){
    document.getElementById('shopCoins').textContent=coins;
    const items=['rainbox','triple_jump'];
    items.forEach(item=>{
        const itemDiv=document.getElementById('item_'+item);
        const btn=document.getElementById('btn_'+item);
        if(!ownedItems[item]){
            itemDiv.classList.remove('owned');
            btn.textContent='BUY NOW';
            btn.disabled=false;
            btn.style.background='linear-gradient(135deg, #4CAF50, #45a049)';
        }else if(itemsEnabled[item]){
            itemDiv.classList.add('owned');
            btn.textContent='ENABLED ‚úì';
            btn.disabled=false;
            btn.style.background='linear-gradient(135deg, #4CAF50, #45a049)';
        }else{
            itemDiv.classList.add('owned');
            btn.textContent='DISABLED';
            btn.disabled=false;
            btn.style.background='linear-gradient(135deg, #ff6b6b, #ee5a6f)';
        }
    });
}
function toggleItem(item,cost){
    if(!ownedItems[item]){
        if(coins>=cost){
            coins-=cost;
            ownedItems[item]=true;
            itemsEnabled[item]=true;
            updateAllCoinDisplays();
            updateShopDisplay();
            alert('‚úì Item purchased and enabled!');
        }else{
            alert('‚ùå Not enough coins! You need '+(cost-coins)+' more coins.');
        }
    }else{
        itemsEnabled[item]=!itemsEnabled[item];
        updateShopDisplay();
        if(itemsEnabled[item]){
            alert('‚úì Item enabled!');
        }else{
            alert('Item disabled');
            if(item==='rainbox'){
                const levelColor=levelColors[currentLevel-1];
                scene.background=new THREE.Color(levelColor).multiplyScalar(0.3);
                scene.fog.color=new THREE.Color(levelColor).multiplyScalar(0.3);
                platforms.forEach(plat=>{
                    if(!plat.userData.isEnd){
                        plat.material.color.setHex(levelColor);
                        plat.material.emissive.setHex(levelColor);
                    }
                });
            }
        }
    }
}
function buyItem(item,cost){
    toggleItem(item,cost);
}
function updateAllCoinDisplays(){
    document.getElementById('coinCounter').textContent=coins;
    document.getElementById('shopCoins').textContent=coins;
    document.getElementById('devCoins').textContent=coins;
    document.getElementById('coinCount').textContent=coins;
}
function addCoins(amount){
    coins+=amount;
    updateAllCoinDisplays();
}
function resetCoins(){
    coins=0;
    updateAllCoinDisplays();
}
function toggleMinimizeDevMenu(){const devWindow=document.getElementById('devWindow');devWindowMinimized=!devWindowMinimized;if(devWindowMinimized){devWindow.classList.add('minimized');}else{devWindow.classList.remove('minimized');}}
function closeDevMenu(){
    flightMode=false;
    infiniteJump=false;
    noclipMode=false;
    godMode=false;
    devModeActive=false;
    speedMultiplier=1.0;
    unlockedLevels=1;
    currentLevel=1;
    generateLevelSelect();
    document.getElementById('devWindow').style.display='none';
    document.getElementById('devBtnDeath').style.display='none';
    document.getElementById('flightBtn').textContent='Flight Mode: OFF';
    document.getElementById('flightBtn').classList.remove('active');
    document.getElementById('infiniteJumpBtn').textContent='Infinite Jump: OFF';
    document.getElementById('infiniteJumpBtn').classList.remove('active');
    document.getElementById('noclipBtn').textContent='Noclip: OFF';
    document.getElementById('noclipBtn').classList.remove('active');
    document.getElementById('godModeBtn').textContent='God Mode: OFF';
    document.getElementById('godModeBtn').classList.remove('active');
    alert('Dev mode closed. All cheats disabled and progress reset.');
}
function skipLevel(){if(currentLevel<MAX_LEVELS){currentLevel++;if(currentLevel>unlockedLevels){unlockedLevels=currentLevel;generateLevelSelect();}document.getElementById('level').textContent=currentLevel;generateLevel(currentLevel);player.position.set(0,2,0);velocity={x:0,y:0,z:0};pitch=0;yaw=0;jumpsRemaining=itemsEnabled.triple_jump?3:2;document.getElementById('distanceDisplay').textContent='0';document.getElementById('progressFill').style.width='0%';}}
function unlockAllLevels(){unlockedLevels=MAX_LEVELS;generateLevelSelect();alert('All levels unlocked!');}
function resetProgress(){unlockedLevels=1;currentLevel=1;generateLevelSelect();alert('Progress reset!');}
function exitGame(){window.close();}
function onMouseMove(event){if(gameState!=='playing')return;yaw-=event.movementX*sensitivity;pitch-=event.movementY*sensitivity;yaw=Math.max(-MAX_YAW,Math.min(MAX_YAW,yaw));pitch=Math.max(MIN_PITCH,Math.min(MAX_PITCH,pitch));}

function updatePlayer(){
    if(gameState!=='playing')return;
    
    if(itemsEnabled.rainbox){
        levelRainbowHue=(levelRainbowHue+0.5)%360;
        const levelColor=new THREE.Color().setHSL(levelRainbowHue/360,0.7,0.5);
        scene.background=new THREE.Color().setHSL(levelRainbowHue/360,0.7,0.3);
        scene.fog.color=new THREE.Color().setHSL(levelRainbowHue/360,0.7,0.3);
        platforms.forEach(plat=>{
            if(!plat.userData.isEnd){
                plat.material.color=levelColor;
                plat.material.emissive=levelColor;
            }
        });
    }
    coinMeshes.forEach(coin=>{
        if(!coin.userData.collected){
            coin.rotation.z+=0.05;
            coin.position.y+=Math.sin(Date.now()*0.003)*0.01;
            const dist=player.position.distanceTo(coin.position);
            if(dist<3){
                coin.userData.collected=true;
                coins++;
                updateAllCoinDisplays();
                createCoinParticles(coin.position);
                showCoinPopup();
                coin.scale.set(0,0,0);
            }
        }
    });
    if(flightMode){
        const flySpeed=0.5;
        const forward=new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
        const right=new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion);
        if(keys['KeyW']){player.position.add(forward.clone().multiplyScalar(flySpeed));}
        if(keys['KeyS']){player.position.add(forward.clone().multiplyScalar(-flySpeed));}
        if(keys['KeyA']){player.position.add(right.clone().multiplyScalar(-flySpeed));}
        if(keys['KeyD']){player.position.add(right.clone().multiplyScalar(flySpeed));}
        if(keys['KeyQ']){player.position.y-=flySpeed*0.5;}
        if(keys['KeyE']){player.position.y+=flySpeed*0.5;}
        velocity.y=0;
    }else{
        velocity.y+=GRAVITY;
        velocity.x=-Math.sin(yaw)*forwardSpeed;
        velocity.z=-Math.cos(yaw)*forwardSpeed;
        player.position.x+=velocity.x;
        player.position.z+=velocity.z;
    }
    if(!flightMode){player.position.y+=velocity.y;}
    onGround=false;
    let touchingEnd=false;
    if(!flightMode){
        for(let platform of platforms){
            const box=new THREE.Box3().setFromObject(platform);
            const playerBox=new THREE.Box3().setFromObject(player);
            if(playerBox.intersectsBox(box)){
                if(platform.userData.isBarrier&&!noclipMode){
                    player.position.z=box.max.z+1;
                    velocity.z=Math.max(0,velocity.z);
                }
                if(velocity.y<0&&player.position.y>platform.position.y&&!noclipMode){
                    player.position.y=platform.position.y+1.5;
                    velocity.y=0;
                    onGround=true;
                    jumpsRemaining=itemsEnabled.triple_jump?3:2;
                    lastGroundTime=performance.now()/1000;
                    if(platform.userData.isEnd){touchingEnd=true;}
                }
            }
        }
    }else{
        for(let platform of platforms){
            if(platform.userData.isEnd){
                const box=new THREE.Box3().setFromObject(platform);
                const playerBox=new THREE.Box3().setFromObject(player);
                if(playerBox.intersectsBox(box)){touchingEnd=true;}
            }
        }
    }
    if(touchingEnd){gameState='levelComplete';document.exitPointerLock();document.getElementById('hud').style.display='none';document.getElementById('crosshair').style.display='none';document.getElementById('coinDisplay').style.display='none';document.getElementById('devWindow').style.display='none';document.getElementById('levelComplete').style.display='block';}
    camera.position.copy(player.position);
    camera.position.y+=1.2;
    camera.rotation.order='YXZ';
    camera.rotation.y=yaw;
    camera.rotation.x=pitch;
    const speed=Math.sqrt(velocity.x*velocity.x+velocity.z*velocity.z);
    document.getElementById('speedDisplay').textContent=(speed*100).toFixed(0);
    const currentDistance=Math.abs(Math.floor(player.position.z));
    document.getElementById('distanceDisplay').textContent=currentDistance;
    const totalLevelDistance=Math.abs(levelEndZ-levelStartZ);
    const traveledDistance=Math.abs(player.position.z-levelStartZ);
    const progress=Math.min(100,(traveledDistance/totalLevelDistance)*100);
    document.getElementById('progressFill').style.width=progress+'%';
    if(player.position.y<-40&&!flightMode&&!godMode){die();}
}

function die(){gameState='dead';document.exitPointerLock();document.getElementById('hud').style.display='none';document.getElementById('crosshair').style.display='none';document.getElementById('coinDisplay').style.display='none';document.getElementById('deathScreen').style.display='block';if(devModeActive){document.getElementById('devWindow').style.display='block';document.getElementById('devBtnDeath').style.display='inline-block';}}
function nextLevel(){currentLevel++;if(currentLevel>unlockedLevels){unlockedLevels=currentLevel;generateLevelSelect();}document.getElementById('levelComplete').style.display='none';if(currentLevel>MAX_LEVELS){alert('üéâ CONGRATULATIONS! You beat all 20 levels!');currentLevel=1;}document.getElementById('level').textContent=currentLevel;generateLevel(currentLevel);player.position.set(0,2,0);velocity={x:0,y:0,z:0};pitch=0;yaw=0;jumpsRemaining=itemsEnabled.triple_jump?3:2;document.getElementById('distanceDisplay').textContent='0';document.getElementById('progressFill').style.width='0%';document.getElementById('hud').style.display='block';document.getElementById('crosshair').style.display='block';document.getElementById('coinDisplay').style.display='block';if(devModeActive){document.getElementById('devWindow').style.display='block';}gameState='playing';setTimeout(()=>{document.body.requestPointerLock();},100);}
function restartLevel(){document.getElementById('deathScreen').style.display='none';generateLevel(currentLevel);player.position.set(0,2,0);velocity={x:0,y:0,z:0};pitch=0;yaw=0;jumpsRemaining=itemsEnabled.triple_jump?3:2;document.getElementById('distanceDisplay').textContent='0';document.getElementById('progressFill').style.width='0%';document.getElementById('hud').style.display='block';document.getElementById('crosshair').style.display='block';document.getElementById('coinDisplay').style.display='block';if(devModeActive)document.getElementById('devWindow').style.display='block';gameState='playing';setTimeout(()=>{document.body.requestPointerLock();},100);}
function pauseGame(){gameState='paused';document.exitPointerLock();document.getElementById('hud').style.display='none';document.getElementById('crosshair').style.display='none';document.getElementById('coinDisplay').style.display='none';if(devModeActive){document.getElementById('devWindow').style.display='block';}showScreen('pauseMenu');}
function resumeGame(){hideAllScreens();document.getElementById('hud').style.display='block';document.getElementById('crosshair').style.display='block';document.getElementById('coinDisplay').style.display='block';if(devModeActive)document.getElementById('devWindow').style.display='block';gameState='playing';setTimeout(()=>{document.body.requestPointerLock();},100);}
function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);}
function animate(){requestAnimationFrame(animate);updatePlayer();renderer.render(scene,camera);}
init();
</script>
</body>
</html>
